<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TIFFY Trader Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #trades, #pool, #wallets { margin-bottom: 20px; }
        #walletForm, #distributeForm { margin-top: 20px; }
        button { padding: 10px; margin-top: 10px; }
        input { padding: 5px; width: 300px; }
    </style>
</head>
<body>
    <h1>TIFFY Trader Dashboard</h1>
    <h2>Recent Trades</h2>
    <div id="trades">Loading trades...</div>
    <h2>Pool Status</h2>
    <div id="pool">Loading pool...</div>
    <h2>Wallet Balances</h2>
    <div id="wallets">Loading wallets...</div>
    <h2>Add Exempt Wallets</h2>
    <form id="walletForm">
        <input type="text" id="newWallets" placeholder="Enter wallet addresses (comma-separated)">
        <button type="submit">Add Wallets</button>
    </form>
    <h2>Distribute BNB to Exempt Wallets</h2>
    <form id="distributeForm">
        <input type="text" id="distributeWallets" placeholder="Enter wallet addresses (comma-separated)">
        <input type="number" id="bnbAmount" placeholder="BNB amount (e.g., 0.0004)" step="0.001">
        <button type="submit">Distribute BNB</button>
    </form>
    <h2>Start Trades</h2>
    <button id="startTrades">Start Trades</button>

    <script>
        const BACKEND_URL = 'https://bucks-bj2k.onrender.com';
        const POOL_ADDRESS = '0x1305302ef3929dd9252b051077e4ca182107f00d';
        const ADMIN_WALLET = '0x2a234d5Cc7431B824723c84c8605fD3968BF0255';
        const LP_WALLET = '0x6a28ae01Ad12bC73D0c70E88D23CeEd6d6382D19';
        const TIFFY_ADDRESS = '0xE488253DD6B4D31431142F1b7601C96f24Fb7dd5';
        const WBNB_ADDRESS = '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c';

        // Validate EIP-55 checksum
        async function isValidAddress(address) {
            if (!address.match(/^0x[a-fA-F0-9]{40}$/)) return false;
            try {
                const res = await fetch(`${BACKEND_URL}/validate-address?address=${address}`);
                const { valid } = await res.json();
                return valid;
            } catch (e) {
                console.error(`Address validation failed: ${e.message}`);
                return false;
            }
        }

        // Fetch live prices
        async function fetchPrices() {
            try {
                const res = await fetch('https://tiffyai.github.io/TIFFY-Market-Value/price.json');
                const data = await res.json();
                if (Date.now() - new Date(data.lastUpdated).getTime() > 1800000) {
                    throw new Error('Stale price data');
                }
                const bnbRes = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=binancecoin&vs_currencies=usd');
                const bnbData = await bnbRes.json();
                return {
                    tiffy: parseFloat(data.tiffyToUSD), // ~$16.959032
                    bnb: bnbData.binancecoin.usd // ~$1030
                };
            } catch (e) {
                console.error(`Price fetch failed: ${e.message}`);
                return { tiffy: 16.959032, bnb: 1030 };
            }
        }

        // Fetch trades
        async function fetchTrades() {
            try {
                const res = await fetch(`${BACKEND_URL}/trades?address=${ADMIN_WALLET}`);
                const data = await res.json();
                const prices = await fetchPrices();
                const trades = data.result.slice(0, 10).map(tx => {
                    const valueBNB = (tx.value / 1e18).toFixed(6);
                    const valueUSD = (valueBNB * prices.bnb).toFixed(2);
                    return `
                        <p>Tx: <a href="https://bscscan.com/tx/${tx.hash}" target="_blank">${tx.hash.slice(0, 10)}...</a><br>
                        Value: ${valueBNB} BNB ($${valueUSD})<br>
                        Time: ${new Date(tx.timeStamp * 1000).toLocaleString()}</p>
                    `;
                }).join('');
                document.getElementById('trades').innerHTML = trades || 'No trades found';
            } catch (e) {
                document.getElementById('trades').innerHTML = 'Failed to load trades';
            }
        }

        // Fetch pool status
        async function fetchPool() {
            try {
                const res = await fetch(`${BACKEND_URL}/pool?pool=${POOL_ADDRESS}`);
                const data = await res.json();
                const prices = await fetchPrices();
                const tiffyBal = (data.tiffy / 1e18).toFixed(2);
                const wbnbBal = (data.wbnb / 1e18).toFixed(4);
                const usdValue = (tiffyBal * prices.tiffy + wbnbBal * prices.bnb).toFixed(2);
                document.getElementById('pool').innerHTML = `TIFFY: ${tiffyBal}, WBNB: ${wbnbBal} (~$${usdValue})`;
            } catch (e) {
                document.getElementById('pool').innerHTML = 'Failed to load pool';
            }
        }

        // Fetch wallet balances
        async function fetchWallets() {
            try {
                const res = await fetch(`${BACKEND_URL}/wallets?admin=${ADMIN_WALLET}&lp=${LP_WALLET}`);
                const data = await res.json();
                document.getElementById('wallets').innerHTML = `
                    Admin (${ADMIN_WALLET}): ${(data.admin / 1e18).toFixed(2)} TIFFY<br>
                    LP (${LP_WALLET}): ${(data.lp / 1e18).toFixed(2)} TIFFY
                `;
            } catch (e) {
                document.getElementById('wallets').innerHTML = 'Failed to load wallets';
            }
        }

        // Add wallets
        document.getElementById('walletForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const wallets = document.getElementById('newWallets').value.split(',').map(w => w.trim());
            const valid = await Promise.all(wallets.map(w => isValidAddress(w)));
            if (wallets.length === 0 || valid.some(v => !v)) {
                alert('Invalid wallet addresses');
                return;
            }
            try {
                const res = await fetch(`${BACKEND_URL}/exempt`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wallets })
                });
                const result = await res.json();
                alert(result.message || 'Wallets added!');
                fetchWallets();
            } catch (e) {
                alert('Failed to add wallets: ' + e.message);
            }
        });

        // Distribute BNB
        document.getElementById('distributeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const wallets = document.getElementById('distributeWallets').value.split(',').map(w => w.trim());
            const amount = parseFloat(document.getElementById('bnbAmount').value);
            const valid = await Promise.all(wallets.map(w => isValidAddress(w)));
            if (wallets.length === 0 || valid.some(v => !v) || isNaN(amount) || amount <= 0) {
                alert('Invalid wallets or BNB amount');
                return;
            }
            try {
                const res = await fetch(`${BACKEND_URL}/distribute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wallets, amount })
                });
                const result = await res.json();
                alert(result.message || `Distributed ${amount} BNB to ${wallets.length} wallets`);
                fetchWallets();
            } catch (e) {
                alert('Failed to distribute BNB: ' + e.message);
            }
        });

        // Start trades
        document.getElementById('startTrades').addEventListener('click', async () => {
            try {
                const res = await fetch(`${BACKEND_URL}/start-trades`);
                const result = await res.json();
                alert(result.message || '100 Trades Successful. Cool, now you can add 5 more wallets. Let\'s run again.');
            } catch (e) {
                alert('Failed to start trades: ' + e.message);
            }
        });

        // Load data
        fetchTrades();
        fetchPool();
        fetchWallets();
        setInterval(fetchTrades, 60000);
        setInterval(fetchPool, 60000);
        setInterval(fetchWallets, 60000);
    </script>
</body>
</html>
